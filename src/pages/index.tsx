import Layout from "@/components/Layout";
import Head from "next/head";
import Filter from "@/components/Filter";
import { CircularProgress, Container, Box } from "@mui/material";
import * as React from "react";
import SChip from "@/components/SChip";
import { GetStaticProps } from "next";
import useAxios from "axios-hooks";
import ProductsList from "@/components/ProductsList";

interface HomeProps {
  categories: Category[];
}

export default function Home({ categories }: HomeProps) {
  const [currentCategory, setCurrentCategory] = React.useState<string>("");
  const [selectedTags, setSelectedTags] = React.useState<Tag[]>([]);
  const [{ data: tags = { data: [] } }] = useAxios({
    url: `${process.env.NEXT_PUBLIC_API_URL}/api/tags`,
    params: { category: currentCategory },
  });
  const tagsParams = selectedTags.map((tag) => tag.name);

  const [{ loading, data: products = { data: [] } }] = useAxios({
    url: `${process.env.NEXT_PUBLIC_API_URL}/api/products`,
    params: { category: currentCategory, tags: tagsParams },
  });

  return (
    <Layout>
      <Head>
        <title>Shop</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <Container maxWidth="md" sx={{ width: "95%" }}>
          <Filter
            {...{ currentCategory, categories }}
            handleChange={(value) => {
              setCurrentCategory(value);
              setSelectedTags([]);
            }}
          />
          <Box display={"flex"} gap={1} width={"100%"} flexWrap={"wrap"}>
            {tags?.data?.map((tag: Tag) => {
              const isDeletable = selectedTags?.includes(tag);
              return (
                <SChip
                  key={tag._id}
                  onDelete={() =>
                    setSelectedTags(
                      selectedTags?.filter((item) => item._id !== tag._id)
                    )
                  }
                  onClick={() => setSelectedTags([...selectedTags, tag])}
                  isDeletable={isDeletable ? true : false}
                  label={tag.name}
                />
              );
            })}
          </Box>

          {loading ? (
            <Box sx={{ display: "flex", justifyContent: "center", mt: 10 }}>
              <CircularProgress sx={{ mx: "auto" }} />
            </Box>
          ) : (
            <ProductsList products={products?.data} />
          )}
        </Container>
      </main>
    </Layout>
  );
}

export const getStaticProps: GetStaticProps = async () => {
  const response = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/categories`
  );
  const { data } = await response.json();

  return { props: { categories: data } };
};
